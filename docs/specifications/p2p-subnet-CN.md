# p2p subnet protocol

在p2p网络内部组建一个虚拟的子网络，该网络由种子节点和共识节点共同维护管理。

## 节点角色的检测
所有节点加入p2p网络后，需要进行自身身份的识别，来确定是否加入子网络。
1. 种子节点身份：通过和自身建立连接进行握手，识别出自身ip，和种子节点的域名解析ip进行匹配，来确认种子节点身份；
2. 共识节点身份：通过治理合约获取当前共识节点列表，和自身地址匹配来确认共识节点身份；

## 子网络加入
节点身份确认后，即可以请求加入子网络，共识节点的请求信息需要带上公钥和签名，种子节点不需要发送公钥和签名。 子网络内的节点收到请求后，对于共识节点，进行验证公钥和签名，并和治理合约中的共识公钥名单进行匹配，对于种子节点，验证其ip为种子节点的域名解析ip。验证完成后，发送子网络的节点列表。后续节点通过定期通讯，来相互同步合并和维护各自的子网络节点列表。

## Peer Mask的变更
共识和种子节点在回应dht节点发现请求时，除了peers.rsv中mask的ip列表外，还需要屏蔽子网络中的节点列表，避免泄漏共识节点的ip给普通节点。

## 普通节点+enableconsensus
由于节点的角色可以动态变化，普通节点需要定期查询治理合约，确保在变为共识节点后能够及时加入共识子网络。

## 共识节点连接控制
共识节点在发起连接前和收到连接前的握手阶段，需要拒绝掉ip不在种子节点列表，peers.rsv中reserve列表或子网络节点列表的节点。

